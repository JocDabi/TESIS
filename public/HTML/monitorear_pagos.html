<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitorear transacciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="icon" href="../img/logo.png">
    <style>
        /* Animación para la notificación */
        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .animate-bounce {
            animation: bounce 1s infinite;
        }

        /* Transición para el indicador de actualización */
        .refresh-indicator-enter-active,
        .refresh-indicator-leave-active {
            transition: all 0.5s ease;
        }

        .refresh-indicator-enter,
        .refresh-indicator-leave-to {
            opacity: 0;
            transform: translateY(-20px);
        }

        * {
            font-family: "Montserrat", sans-serif;
        }

        /* Estilos para los menús desplegables */
        .dropdown:hover .dropdown-menu {
            display: block;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #e2e8f0;
            padding: 0.5rem 0;
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1);
            min-width: 220px;
            z-index: 10;
        }

        .dropdown-menu a {
            padding: 0.75rem 1.25rem;
            display: block;
            color: #4a5568;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.9rem;
        }

        .dropdown-menu a:hover {
            background-color: #f7fafc;
            color: #1a202c;
        }

        /* Animación para el spinner de carga */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body class="bg-cover bg-left flex flex-col min-h-screen" style="background-image: url('../img/background2.png');">

    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex w-full">
                    <div class="hidden md:ml-6 md:flex space-x-8">
                        <a href="./dashboard.html"
                            class="text-gray-700 hover:bg-gray-100 px-3 py-5 rounded-md text-sm font-medium flex items-center focus:outline-none">
                            <img src="../img/pagina-de-inicio.png" alt="Inicio" class="h-6 w-6">
                        </a>

                        <div class="dropdown relative">
                            <button
                                class="text-gray-700 hover:bg-gray-100 px-3 py-5 rounded-md text-sm font-medium focus:outline-none">
                                Transacciones
                            </button>
                            <div class="dropdown-menu absolute mt-2 right-0 md:left-0">
                                <a href="./monitorear_pagos.html"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Monitorear
                                    transacciones</a>

                            </div>
                        </div>
                        <div class="dropdown relative">
                            <button
                                class="text-gray-700 hover:bg-gray-100 px-3 py-5 rounded-md text-sm font-medium focus:outline-none">
                                Reportes y gráficos
                            </button>
                            <div class="dropdown-menu absolute mt-2 right-0 md:left-0">
                                <a href="./generar_lista_pagos.html"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Generar Lista de
                                    transacciones</a>
                                <a href="./generar_graficos_estadisticas_transacciones.html"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Generar gráficos de
                                    estadísticas de las transacciones</a>
                            </div>
                        </div>
                        <div class="dropdown relative">
                            <button
                                class="text-gray-700 hover:bg-gray-100 px-3 py-5 rounded-md text-sm font-medium focus:outline-none">
                                Ayuda
                            </button>
                            <div class="dropdown-menu absolute mt-2 right-0 md:left-0">
                                <a href="https://drive.google.com/file/d/14QMIce3wAl_U6npZcz1KIhUZXwEFyH54/view"
                                    target="_blank" rel="noopener"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Manual de
                                    usuario</a>

                                <a href="./preguntas_frecuentes.html"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Preguntas
                                    frecuentes</a>
                                <a href="./informacion_sistema.html"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Información
                                    del sistema</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hidden md:flex items-center">
                    <button id="logout-button"
                        class="text-gray-700 hover:bg-gray-100 px-3 py-2 rounded-md text-sm font-medium flex items-center focus:outline-none">
                        <img src="../img/cerrar-sesion-de-usuario.png" alt="Cerrar sesión" class="h-6 w-6">
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Loader -->
    <div id="loader" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <p class="text-lg font-semibold">Cargando datos...</p>
            <div class="mt-4 flex justify-center">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-gray-900"></div>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 pt-4">
        <div class="px-4 py-6 sm:px-0">
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800">Monitoreo de transacciones</h2>
                </div>

                <div class="p-6">

                    <div class="mb-4 flex space-x-4 items-end">
                        <div class="relative">
                            <label for="filtro-fecha-inicio" class="block text-gray-700 text-sm font-bold mb-2">Fecha
                                Inicio:</label>
                            <input type="date" id="filtro-fecha-inicio"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>

                        <div class="relative">
                            <label for="filtro-fecha-fin" class="block text-gray-700 text-sm font-bold mb-2">Fecha
                                Fin:</label>
                            <input type="date" id="filtro-fecha-fin"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div id="mensaje-error-fechas" class="text-red-500 text-sm mt-2 hidden">La fecha de inicio no
                            puede ser mayor que la fecha fin
                        </div>

                        <div class="relative">
                            <label for="filtro-estado"
                                class="block text-gray-700 text-sm font-bold mb-2">Estado:</label>
                            <select id="filtro-estado"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="">Todos</option>
                                <option value="ready_to_be_checked">Lista para verificar</option>
                                <option value="completed">Completado</option>
                                <option value="rejected">Rechazado</option>
                            </select>
                        </div>
                        <div class="relative">
                            <label for="selectPaginas"
                                class="block text-gray-700 text-sm font-bold mb-2">Mostrar:</label>
                            <select id="selectPaginas" class="shadow border rounded py-2 px-3 text-gray-700">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="250">250</option>
                            </select>
                        </div>
                    </div>


                    <div class="overflow-x-auto">
                        <table id="pagosTable" class="min-w-full table-auto border-collapse border border-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border border-gray-200 px-4 py-2 text-left">ID Pago</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Fecha</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Cliente</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Monto</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Estado</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            <tfoot id="tiempoConsultaFooter">
                                <!-- El tiempo de consulta se mostrará aquí -->
                            </tfoot>
                        </table>
                    </div>

                    <div id="pagosTablePaginationInfo" class="mt-6 flex justify-between items-center">
                        <div id="infoPaginacion" class="text-gray-700 text-sm">
                            Cargando...
                        </div>
                        <div class="space-x-2">
                            <button id="btnAnterior"
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded disabled:opacity-50"
                                disabled>Anterior</button>
                            <button id="btnSiguiente"
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded disabled:opacity-50"
                                disabled>Siguiente</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white text-center py-4 mt-auto">
        <p>&copy; 2025 DCM Development. Todos los derechos reservados.</p>
    </footer>

    <div id="paymentDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Detalles de la transacción</h3>
                <div class="mt-2 px-7 py-3 text-left">
                    <p class="text-sm text-gray-500 mt-4">
                        <strong>Información del pago:</strong>
                    </p>
                    <p class="text-sm text-gray-500 ml-4 ">
                        <strong>ID Pago:</strong> <span id="modal-id-pago"></span>
                    </p>
                    <p class="text-sm text-gray-500 ml-4">
                        <strong>Fecha:</strong> <span id="modal-fecha-pago"></span>
                    </p>
                    <p class="text-sm text-gray-500 ml-4">
                        <strong>Monto:</strong> <span id="modal-monto-pago"></span>
                    </p>
                    <p class="text-sm text-gray-500 ml-4">
                        <strong>Descripción:</strong> <span id="modal-descripcion-pago"></span>
                    </p>
                    <p class="text-sm text-gray-500 ml-4">
                        <strong>Método de Pago:</strong> <span id="modal-metodo-pago"></span>
                    </p>
                    <p class="text-sm text-gray-500 ml-4">
                        <strong>Estado:</strong> <span id="modal-estado-pago"></span>
                    </p>
                    <p class="text-sm text-gray-500 mt-4">
                        <strong>Información del Usuario:</strong>
                    </p>
                    <p class="text-sm text-gray-500 ml-4">
                        <strong>Nombre:</strong> <span id="modal-user-name"></span>
                    </p>
                    <p class="text-sm text-gray-500 ml-4">
                        <strong>Email:</strong> <span id="modal-user-email"></span>
                    </p>
                    <p class="text-sm text-gray-500 ml-4">
                        <strong>Identificación:</strong> <span id="modal-user-id-number"></span>
                    </p>
                    <!-- Nueva sección de información del curso -->
                    <p class="text-sm text-gray-500 mt-4">
                        <strong>Información del Curso:</strong>
                    </p>
                    <p class="text-sm text-gray-500 ml-4">
                        <strong>ID Curso:</strong> <span id="modal-course-id"></span>
                    </p>
                    <p class="text-sm text-gray-500 ml-4">
                        <strong>Fecha Creación:</strong> <span id="modal-course-created"></span>
                    </p>
                    <p class="text-sm text-gray-500 ml-4">
                        <strong>Nombre:</strong> <span id="modal-course-name"></span>
                    </p>
                    <p class="text-sm text-gray-500 ml-4">
                        <strong>Descripción:</strong> <span id="modal-course-description"></span>
                    </p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeModalButton"
                        class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div id="logoutModal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center z-50">
        <div class="relative p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Confirmar cierre de sesión</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">¿Estás seguro de que quieres cerrar tu sesión?</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmLogout"
                        class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 sm:ml-3 sm:w-auto sm:text-sm">
                        Sí, cerrar sesión
                    </button>
                    <button id="cancelLogout"
                        class="mt-3 px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-75 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>

        async function cargarPagos() {
            const registrosPorPagina = parseInt(document.getElementById("registrosPorPagina").value);
            const fechaInicio = document.getElementById("filtro-fecha-inicio").value;
            const fechaFin = document.getElementById("filtro-fecha-fin").value;
            const estado = document.getElementById("filtro-estado").value;

            if (fechaInicio && fechaFin && fechaInicio > fechaFin) {
                document.getElementById("mensaje-error-fechas").classList.remove("hidden");
                return;
            } else {
                document.getElementById("mensaje-error-fechas").classList.add("hidden");
            }

            try {
                const response = await fetch(`https://tu-api.com/api/pagos?pagina=${paginaActual}&limite=${registrosPorPagina}&fechaInicio=${fechaInicio}&fechaFin=${fechaFin}&estado=${estado}`);
                const data = await response.json();

                totalPaginas = Math.ceil(data.total / registrosPorPagina);
                document.querySelector("#infoPaginacion").innerText = `Página ${paginaActual} de ${totalPaginas}`;

                const tbody = document.querySelector("#pagosTable tbody");
                tbody.innerHTML = "";

                data.pagos.forEach(pago => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td class="border px-4 py-2">${pago.id}</td>
                    <td class="border px-4 py-2">${pago.fecha}</td>
                    <td class="border px-4 py-2">${pago.cliente}</td>
                    <td class="border px-4 py-2">${pago.monto}</td>
                    <td class="border px-4 py-2">${pago.estado}</td>
                    <td class="border px-4 py-2">
                        <button onclick="verDetalle(${pago.id})" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded">Ver</button>
                    </td>
                `;
                    tbody.appendChild(row);
                });

                document.getElementById("btnAnterior").disabled = paginaActual === 1;
                document.getElementById("btnSiguiente").disabled = paginaActual === totalPaginas;

            } catch (error) {
                console.error("Error al cargar pagos:", error);
            }
        }

        function verDetalle(id) {
            // Lógica para mostrar detalles en el modal
            console.log("Ver detalle de pago ID:", id);
        }

        document.addEventListener('DOMContentLoaded', function () {
            const fechaInicio = document.getElementById('filtro-fecha-inicio');
            const fechaFin = document.getElementById('filtro-fecha-fin');
            const mensajeError = document.getElementById('mensaje-error-fechas');

            [fechaInicio, fechaFin].forEach(input => {
                input.addEventListener('change', validarFechas);
            });

            function validarFechas() {
                if (!fechaInicio.value || !fechaFin.value) {
                    mensajeError.classList.add('hidden');
                    return;
                }

                const inicio = new Date(fechaInicio.value);
                const fin = new Date(fechaFin.value);

                if (inicio > fin) {
                    mensajeError.classList.remove('hidden');
                    fechaInicio.classList.add('border-red-500');
                    fechaFin.classList.add('border-red-500');
                } else {
                    mensajeError.classList.add('hidden');
                    fechaInicio.classList.remove('border-red-500');
                    fechaFin.classList.remove('border-red-500');
                }
            }
        });
        document.addEventListener('DOMContentLoaded', function () {
            // Referencias a elementos de la interfaz
            const pagosTableBody = document.querySelector('#pagosTable tbody');
            const paginationInfoDiv = document.getElementById('pagosTablePaginationInfo');
            const filtroFechaInicio = document.getElementById('filtro-fecha-inicio');
            const filtroFechaFin = document.getElementById('filtro-fecha-fin');
            const filtroEstado = document.getElementById('filtro-estado');
            const selectPaginas = document.getElementById('selectPaginas');
            const tiempoConsultaFooter = document.getElementById('tiempoConsultaFooter');

            // --- Referencias del Modal ---
            const paymentDetailModal = document.getElementById('paymentDetailModal');
            const closeModalButton = document.getElementById('closeModalButton');

            const modalIdPago = document.getElementById('modal-id-pago');
            const modalFechaPago = document.getElementById('modal-fecha-pago');
            const modalMontoPago = document.getElementById('modal-monto-pago');
            const modalDescripcionPago = document.getElementById('modal-descripcion-pago');
            const modalMetodoPago = document.getElementById('modal-metodo-pago');
            const modalEstadoPago = document.getElementById('modal-estado-pago');
            const modalUserName = document.getElementById('modal-user-name');
            const modalUserEmail = document.getElementById('modal-user-email');
            const modalUserIdNumber = document.getElementById('modal-user-id-number');
            // Nuevas referencias para el curso
            const modalCourseId = document.getElementById('modal-course-id');
            const modalCourseCreated = document.getElementById('modal-course-created');
            const modalCourseName = document.getElementById('modal-course-name');
            const modalCourseDescription = document.getElementById('modal-course-description');
            // --- Fin Referencias del Modal ---

            let currentPaymentsData = []; // Variable para almacenar los pagos actualmente cargados
            let paginaActual = 1;
            let totalPagos = 0; // Variable global para el total de pagos

            // Función para mapear el estado del pago a texto legible y clase de color de Tailwind
            function getStatusDisplay(status) {
                switch (status) {
                    case 'ready_to_be_checked':
                        return { text: 'Lista para verificar', class: 'text-yellow-800 bg-yellow-100' };
                    case 'completed':
                        return { text: 'Completado', class: 'text-green-800 bg-green-100' };
                    case 'rejected':
                        return { text: 'Rechazado', class: 'text-red-800 bg-red-100' };
                    case 'in_process':
                        return { text: 'En proceso', class: 'text-blue-800 bg-blue-100' };
                    default:
                        return { text: status || 'Desconocido', class: 'text-gray-800 bg-gray-100' };
                }
            }

            // Función para cargar y mostrar los pagos
            function fetchAndDisplayPayments(filters = {}, pagina = 1, limite = 25) {
                // Mostrar loader
                document.getElementById('loader').classList.remove('hidden');

                // Limpiar tabla
                pagosTableBody.innerHTML = `<tr><td colspan="6" class="border border-gray-200 px-4 py-2 text-center text-gray-500">Cargando pagos...</td></tr>`;

                // Limpiar tiempo de consulta anterior
                tiempoConsultaFooter.innerHTML = '';

                // Iniciar medición de tiempo
                const inicioTiempo = performance.now();

                const apiUrlBase = '../../php/get_pagos.php';
                const queryParams = new URLSearchParams({
                    ...filters,
                    pagina,
                    limite
                }).toString();
                const apiUrl = `${apiUrlBase}?${queryParams}`;

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(`Error HTTP ${response.status}: ${response.statusText} - ${text}`); });
                        }
                        return response.json();
                    })
                    .then(response_data => {
                        // Calcular tiempo de consulta
                        const finTiempo = performance.now();
                        const tiempoConsulta = (finTiempo - inicioTiempo) / 1000; // Convertir a segundos

                        // Ocultar loader
                        document.getElementById('loader').classList.add('hidden');

                        currentPaymentsData = response_data.data;
                        pagosTableBody.innerHTML = '';

                        const pagos = response_data.data;
                        totalPagos = response_data.total;

                        // --- Cálculo de total de páginas ---
                        const totalPaginas = Math.ceil(totalPagos / limite);

                        // --- Habilitar/deshabilitar botones ---
                        document.getElementById('btnAnterior').disabled = (pagina <= 1);
                        document.getElementById('btnSiguiente').disabled = (pagina >= totalPaginas || totalPaginas === 0);

                        // --- Actualizar info de paginación ---
                        if (paginationInfoDiv) {
                            const displayedCount = pagos.length;
                            const startCount = pagos.length > 0 ? (limite * (pagina - 1)) + 1 : 0;
                            const endCount = (limite * (pagina - 1)) + displayedCount;
                            paginationInfoDiv.querySelector('.text-gray-700').textContent = `Mostrando ${startCount} a ${endCount} de ${totalPagos} pagos`;
                        }

                        if (pagos && Array.isArray(pagos) && pagos.length > 0) {
                            pagos.forEach(pago => {
                                const row = document.createElement('tr');

                                const idPago = pago.id || 'N/A';
                                const fecha = pago.createdAt ? pago.createdAt.split('T')[0] : 'N/A';
                                const cliente = (pago.user && pago.user.firstName && pago.user.lastName) ? `${pago.user.firstName} ${pago.user.lastName}` : (pago.user && pago.user.email) ? pago.user.email : 'Desconocido';
                                const monto = pago.amount ? `$${parseFloat(pago.amount).toFixed(2)}` : 'N/A';
                                const estadoInfo = getStatusDisplay(pago.status);

                                row.innerHTML = `
                                    <td class="border border-gray-200 px-4 py-2">${idPago}</td>
                                    <td class="border border-gray-200 px-4 py-2">${fecha}</td>
                                    <td class="border border-gray-200 px-4 py-2">${cliente}</td>
                                    <td class="border border-gray-200 px-4 py-2">${monto}</td>
                                    <td class="border border-gray-200 px-4 py-2">
                                        <span class="inline-block px-2 py-1 text-xs font-semibold leading-tight rounded-full ${estadoInfo.class}">
                                            ${estadoInfo.text}
                                        </span>
                                    </td>
                                    <td class="border border-gray-200 px-4 py-2">
                                        <button class="btn-ver-detalle bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded text-xs" data-id="${idPago}">Ver Detalle</button>
                                    </td>
                                `;

                                pagosTableBody.appendChild(row);
                            });

                            // Mostrar tiempo de consulta
                            tiempoConsultaFooter.innerHTML = `
                                <tr>
                                    <td colspan="6" class="border-t border-gray-200 px-4 py-2 text-sm text-gray-500">
                                        Tiempo de consulta: ${tiempoConsulta.toFixed(4)} segundos
                                    </td>
                                </tr>
                            `;

                            // === Añadir Event Listeners a los botones "Ver Detalle" ===
                            pagosTableBody.querySelectorAll('.btn-ver-detalle').forEach(button => {
                                button.addEventListener('click', function () {
                                    const pagoId = this.getAttribute('data-id');
                                    displayPaymentDetailsModal(pagoId);
                                });
                            });

                        } else if (pagos && Array.isArray(pagos) && pagos.length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = `<td colspan="6" class="border border-gray-200 px-4 py-2 text-center text-gray-500">No se encontraron pagos con los criterios seleccionados.</td></tr>`;
                            pagosTableBody.appendChild(row);
                            if (paginationInfoDiv) {
                                paginationInfoDiv.querySelector('.text-gray-700').textContent = '0 pagos encontrados.';
                            }

                        } else {
                            console.error('Respuesta inesperada del servidor:', response_data);
                            const row = document.createElement('tr');
                            row.innerHTML = `<td colspan="6" class="border border-gray-200 px-4 py-2 text-center text-red-500">Error: Formato de datos inesperado.</td></tr>`;
                            pagosTableBody.appendChild(row);
                            if (paginationInfoDiv) {
                                paginationInfoDiv.querySelector('.text-gray-700').textContent = '';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error al obtener los pagos:', error);
                        document.getElementById('loader').classList.add('hidden');
                        pagosTableBody.innerHTML = `<tr><td colspan="6" class="border border-gray-200 px-4 py-2 text-center text-red-500">Error al cargar los pagos. Inténtelo de nuevo. Detalles en consola.</td></tr>`;
                        tiempoConsultaFooter.innerHTML = '';
                        if (paginationInfoDiv) {
                            paginationInfoDiv.querySelector('.text-gray-700').textContent = '';
                        }
                    });
            }


            // --- Nueva Función para Mostrar Detalles del Pago en un Modal ---
            function displayPaymentDetailsModal(pagoId) {
                const pago = currentPaymentsData.find(p => p.id === pagoId);

                if (pago) {
                    const estadoInfo = getStatusDisplay(pago.status);

                    modalIdPago.textContent = pago.id || 'N/A';
                    modalFechaPago.textContent = pago.createdAt ? pago.createdAt.split('T')[0] : 'N/A';
                    modalMontoPago.textContent = pago.amount ? `$${parseFloat(pago.amount).toFixed(2)}` : 'N/A';
                    modalDescripcionPago.textContent = pago.description || 'Sin descripción';
                    modalMetodoPago.textContent = pago.paymentMethod || 'N/A';
                    modalEstadoPago.textContent = estadoInfo.text;

                    modalUserName.textContent = (pago.user && pago.user.firstName && pago.user.lastName) ? `${pago.user.firstName} ${pago.user.lastName}` : 'Desconocido';
                    modalUserEmail.textContent = (pago.user && pago.user.email) ? pago.user.email : 'N/A';
                    modalUserIdNumber.textContent = (pago.user && pago.user.identificationNumber) ? pago.user.identificationNumber : 'N/A';

                    // Nueva información del curso
                    modalCourseId.textContent = (pago.course && pago.course.id) ? pago.course.id : 'N/A';
                    modalCourseCreated.textContent = (pago.course && pago.course.createdAt) ? pago.course.createdAt.split('T')[0] : 'N/A';
                    modalCourseName.textContent = (pago.course && pago.course.name) ? pago.course.name : 'N/A';
                    modalCourseDescription.textContent = (pago.course && pago.course.description) ? pago.course.description : 'N/A';

                    paymentDetailModal.classList.remove('hidden');
                } else {
                    alert('No se encontraron detalles para este pago.');
                    console.warn('Pago con ID ' + pagoId + ' no encontrado en los datos cargados.');
                }
            }
            // --- Fin Nueva Función del Modal ---

            // --- Evento para Cerrar el Modal ---
            if (closeModalButton) {
                closeModalButton.addEventListener('click', function () {
                    paymentDetailModal.classList.add('hidden');
                });
            }

            if (paymentDetailModal) {
                paymentDetailModal.addEventListener('click', function (event) {
                    if (event.target === paymentDetailModal) {
                        paymentDetailModal.classList.add('hidden');
                    }
                });
            }

            // Evento para el select de estado que filtra automáticamente
            filtroEstado.addEventListener('change', function () {
                paginaActual = 1;
                const filters = {
                    fecha_inicio: filtroFechaInicio.value,
                    fecha_fin: filtroFechaFin.value,
                    estado: this.value
                };
                fetchAndDisplayPayments(filters, paginaActual, parseInt(selectPaginas.value));
            });

            // Evento para el select de cantidad de páginas:
            selectPaginas.addEventListener('change', function () {
                paginaActual = 1;
                const filters = {
                    fecha_inicio: filtroFechaInicio.value,
                    fecha_fin: filtroFechaFin.value,
                    estado: filtroEstado.value
                };
                fetchAndDisplayPayments(filters, paginaActual, parseInt(selectPaginas.value));
            });

            // Eventos para paginación:
            document.getElementById('btnAnterior').addEventListener('click', function () {
                if (paginaActual > 1) {
                    paginaActual--;
                    const filters = {
                        fecha_inicio: filtroFechaInicio.value,
                        fecha_fin: filtroFechaFin.value,
                        estado: filtroEstado.value
                    };
                    fetchAndDisplayPayments(filters, paginaActual, parseInt(selectPaginas.value));
                }
            });
            document.getElementById('btnSiguiente').addEventListener('click', function () {
                paginaActual++;
                const filters = {
                    fecha_inicio: filtroFechaInicio.value,
                    fecha_fin: filtroFechaFin.value,
                    estado: filtroEstado.value
                };
                fetchAndDisplayPayments(filters, paginaActual, parseInt(selectPaginas.value));
            });

            // === Llamar a la función para cargar y mostrar los pagos al cargar la página (sin filtros inicialmente) ===
            fetchAndDisplayPayments({}, paginaActual, parseInt(selectPaginas.value));
        });

        // Lógica para el modal de cerrar sesión
        const logoutButton = document.getElementById('logout-button');
        const logoutModal = document.getElementById('logoutModal');
        const confirmLogoutButton = document.getElementById('confirmLogout');
        const cancelLogoutButton = document.getElementById('cancelLogout');

        // Mostrar el modal cuando se hace clic en "Cerrar sesión"
        logoutButton.addEventListener('click', function (event) {
            event.preventDefault(); // Prevenir el comportamiento por defecto del enlace
            logoutModal.classList.remove('hidden');
        });

        // Ocultar el modal cuando se hace clic en "Cancelar"
        cancelLogoutButton.addEventListener('click', function () {
            logoutModal.classList.add('hidden');
        });

        // Ocultar el modal si se hace clic fuera de él (opcional, pero buena UX)
        logoutModal.addEventListener('click', function (event) {
            if (event.target === logoutModal) {
                logoutModal.classList.add('hidden');
            }
        });

        // Lógica cuando se confirma el cierre de sesión
        confirmLogoutButton.addEventListener('click', function () {
            // Aquí iría la lógica real para cerrar la sesión:
            // - Limpiar cookies/localStorage (ej. tokens de autenticación)
            // - Redirigir a la página de inicio de sesión o a la página principal.

            // Por ahora, solo simularemos la redirección
            console.log("Cerrando sesión...");

            // Redirige a index.php
            window.location.href = '../index.php'; // Usa './index.php' si está en la misma carpeta raíz o similar

            // Si necesitas limpiar alguna data antes de la redirección, hazlo aquí.
            // Por ejemplo, para limpiar un token de autenticación en localStorage:
            // localStorage.removeItem('authToken'); 

            // El modal se ocultará automáticamente con la redirección,
            // pero puedes mantener la línea si lo deseas para casos de prueba o si la redirección no ocurre inmediatamente.
            logoutModal.classList.add('hidden');
        });
    </script>

    <script>
 // Variables globales para el polling y estado de la aplicación
    let pollingInterval = 15000; // 15 segundos (ajusta según necesites)
    let pollingTimer = null;
    let lastPaymentId = null;
    let paginaActual = 1; // Definir la variable globalmente
    let selectPaginas = document.getElementById('selectPaginas'); // Definir globalmente

    // Referencias a elementos del DOM (definirlas globalmente)
    const filtroFechaInicio = document.getElementById('filtro-fecha-inicio');
    const filtroFechaFin = document.getElementById('filtro-fecha-fin');
    const filtroEstado = document.getElementById('filtro-estado');
    const paymentDetailModal = document.getElementById('paymentDetailModal');

    // Función para obtener los filtros actuales
    function getCurrentFilters() {
        return {
            fecha_inicio: filtroFechaInicio.value,
            fecha_fin: filtroFechaFin.value,
            estado: filtroEstado.value
        };
    }

    // Función para iniciar el polling
    function startPolling() {
        // Detener cualquier polling existente
        stopPolling();
        
        // Obtener los filtros actuales
        const filters = getCurrentFilters();
        
        // Hacer la primera verificación inmediatamente
        checkForNewPayments(filters);
        
        // Configurar el intervalo para verificaciones periódicas
        pollingTimer = setInterval(() => {
            checkForNewPayments(filters);
        }, pollingInterval);
    }

    // Función para detener el polling
    function stopPolling() {
        if (pollingTimer) {
            clearInterval(pollingTimer);
            pollingTimer = null;
        }
    }

    // Función para verificar nuevos pagos
    function checkForNewPayments(filters) {
        // Mostrar indicador de actualización en la interfaz
        showRefreshIndicator();
        
        // Hacer una consulta rápida para el último pago
        fetch(`../../php/get_pagos.php?${new URLSearchParams({
            ...filters,
            pagina: 1,
            limite: 1,
            order: 'desc', // Ordenar por el más reciente primero
            order_by: 'createdAt'
        })}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Ocultar indicador de actualización
            hideRefreshIndicator();
            
            if (data.data && data.data.length > 0) {
                const newestPayment = data.data[0];
                
                // Si es la primera verificación o si hay un pago nuevo
                if (lastPaymentId === null || newestPayment.id !== lastPaymentId) {
                    // Actualizar el ID del último pago conocido
                    lastPaymentId = newestPayment.id;
                    
                    // Solo recargar si estamos en la primera página
                    if (paginaActual === 1) {
                        // Llamar a la función principal de carga de datos
                        if (typeof fetchAndDisplayPayments === 'function') {
                            fetchAndDisplayPayments(filters, paginaActual, parseInt(selectPaginas.value));
                        } else {
                            console.error('fetchAndDisplayPayments no está definida');
                        }
                    } else {
                        // Mostrar notificación de nuevos pagos
                        showNewPaymentsNotification();
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error en polling:', error);
            hideRefreshIndicator();
        });
    }

    // Función para mostrar notificación de nuevos pagos
    function showNewPaymentsNotification() {
        // Si ya hay una notificación, no mostrar otra
        if (document.getElementById('new-payments-notification')) {
            return;
        }
        
        const notification = document.createElement('div');
        notification.id = 'new-payments-notification';
        notification.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded shadow-lg cursor-pointer animate-bounce';
        notification.innerHTML = `
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                </svg>
                <span>Hay nuevos pagos disponibles. <u>Click para actualizar</u></span>
            </div>
        `;
        
        notification.addEventListener('click', () => {
            const filters = getCurrentFilters();
            paginaActual = 1;
            if (typeof fetchAndDisplayPayments === 'function') {
                fetchAndDisplayPayments(filters, paginaActual, parseInt(selectPaginas.value));
            }
            notification.remove();
        });
        
        document.body.appendChild(notification);
        
        // Auto-ocultar después de 15 segundos
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 15000);
    }

    // Función para mostrar indicador de actualización
    function showRefreshIndicator() {
        const existingIndicator = document.getElementById('refresh-indicator');
        if (existingIndicator) return;
        
        const indicator = document.createElement('div');
        indicator.id = 'refresh-indicator';
        indicator.className = 'fixed top-4 right-4 bg-white shadow-md rounded-full p-2 flex items-center';
        indicator.innerHTML = `
            <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-2 text-sm text-gray-600">Buscando actualizaciones...</span>
        `;
        
        document.body.appendChild(indicator);
    }

    // Función para ocultar indicador de actualización
    function hideRefreshIndicator() {
        const indicator = document.getElementById('refresh-indicator');
        if (indicator && indicator.parentNode) {
            indicator.parentNode.removeChild(indicator);
        }
    }

    // Iniciar el polling cuando la página está lista
    document.addEventListener('DOMContentLoaded', function() {
        // Iniciar el polling después de la primera carga de datos
        startPolling();
        
        // Pausar el polling cuando el modal está abierto
        if (paymentDetailModal) {
            paymentDetailModal.addEventListener('mouseenter', stopPolling);
            paymentDetailModal.addEventListener('mouseleave', startPolling);
        }
        
        // Reiniciar el polling cuando cambian los filtros
        [filtroFechaInicio, filtroFechaFin, filtroEstado].forEach(element => {
            if (element) {
                element.addEventListener('change', () => {
                    lastPaymentId = null; // Resetear para forzar una nueva comparación
                    startPolling();
                });
            }
        });
        
        // Ajustar el intervalo según la selección de páginas
        if (selectPaginas) {
            selectPaginas.addEventListener('change', () => {
                // Si el usuario selecciona mostrar más elementos, podemos hacer polling menos frecuente
                const limit = parseInt(selectPaginas.value);
                pollingInterval = limit > 50 ? 60000 : 30000; // 60 segundos para límites grandes
                startPolling();
            });
        }
    });
    </script>


</body>

</html>