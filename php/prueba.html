<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadisticas de Transacciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
    <style>
        * {
            font-family: "Montserrat", sans-serif;
        }
        .dropdown:hover .dropdown-menu {
            display: block;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #e2e8f0;
            padding: 0.5rem 0;
            box-shadow: 0 2px 4px 0 rgba(0,0,0,0.1);
            min-width: 220px;
            z-index: 10;
        }
        .dropdown-menu a {
            padding: 0.75rem 1.25rem;
            display: block;
            color: #4a5568;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.9rem;
        }
        .dropdown-menu a:hover {
            background-color: #f7fafc;
            color: #1a202c;
        }
        /* Animación para el spinner de carga */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .tab-button {
            transition: all 0.2s ease;
        }
        .tab-button.active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loader -->
    <div id="loader" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <h3 class="text-lg font-semibold text-gray-800">Procesando datos</h3>
            <p class="text-gray-600" id="loaderMessage">Cargando información de transacciones...</p>
        </div>
    </div>

    <!-- Navbar (mantener tu navbar existente) -->
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex w-full">
                    <div class="hidden md:ml-6 md:flex space-x-8">
                        <a href="./dashboard.html" class="text-gray-700 hover:bg-gray-100 px-3 py-5 rounded-md text-sm font-medium flex items-center focus:outline-none">
                            <img src="../img/pagina-de-inicio.png" alt="Inicio" class="h-6 w-6">
                        </a>

                        <div class="dropdown relative">
                            <button
                                class="text-gray-700 hover:bg-gray-100 px-3 py-5 rounded-md text-sm font-medium focus:outline-none">
                                Transacciones
                            </button>
                            <div class="dropdown-menu absolute mt-2 right-0 md:left-0">
                                <a href="./monitorear_pagos.html"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Monitorear y
                                    detectar transacciones</a>
                                
                            </div>
                        </div>
                        <div class="dropdown relative">
                            <button class="text-gray-700 hover:bg-gray-100 px-3 py-5 rounded-md text-sm font-medium focus:outline-none">
                                Reportes y gráficos
                            </button>
                            <div class="dropdown-menu absolute mt-2 right-0 md:left-0">
                                <a href="./generar_lista_pagos.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Generar Lista de transacciones</a>
                                <a href="./generar_graficos_estadisticas_transacciones.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Generar gráficos de estadísticas de las transacciones</a>
                            </div>
                        </div>
                        <div class="dropdown relative">
                            <button class="text-gray-700 hover:bg-gray-100 px-3 py-5 rounded-md text-sm font-medium focus:outline-none">
                                Ayuda
                            </button>
                            <div class="dropdown-menu absolute mt-2 right-0 md:left-0">
                                <a href="https://drive.google.com/file/d/14QMIce3wAl_U6npZcz1KIhUZXwEFyH54/view" target="_blank" rel="noopener" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Manual de usuario</a>
                                <a href="./preguntas_frecuentes.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Preguntas frecuentes</a>
                                <a href="./informacion_sistema.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Información del sistema</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hidden md:flex items-center">
                    <button id="logout-button" class="text-gray-700 hover:bg-gray-100 px-3 py-2 rounded-md text-sm font-medium flex items-center focus:outline-none">
                        <img src="../img/cerrar-sesion-de-usuario.png" alt="Cerrar sesión" class="h-6 w-6">
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
            <div class="px-6 py-4 bg-gradient-to-r from-blue-500 to-blue-600">
                <h1 class="text-2xl font-bold text-white">Estadisticas de Transacciones</h1>
                <p class="text-blue-100">Visualización completa de las transacciones de la pasarela de pagos PayStudy</p>
            </div>
            
            <!-- Filtros -->
            <div class="p-6 border-b">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio</label>
                        <input type="date" id="filtro-fecha-inicio" class="w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Fin</label>
                        <input type="date" id="filtro-fecha-fin" class="w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex items-end">
                        <button id="btnGenerarReporte" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                            <i class="fas fa-sync-alt mr-2"></i>Actualizar
                        </button>
                    </div>
                    <div class="flex items-end">
                        <button id="btnExportar" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition">
                            <i class="fas fa-file-export mr-2"></i>Exportar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Pestañas -->
            <div class="border-b border-gray-200">
                <nav class="flex -mb-px">
                    <button id="tab-resumen" class="tab-button active py-4 px-6 text-center border-b-2 font-medium text-sm">
                        <i class="fas fa-chart-pie mr-2"></i>Resumen
                    </button>
                    <button id="tab-cursos" class="tab-button py-4 px-6 text-center border-b-2 font-medium text-sm">
                        <i class="fas fa-graduation-cap mr-2"></i>Por Cursos
                    </button>
                    <button id="tab-metodos" class="tab-button py-4 px-6 text-center border-b-2 font-medium text-sm">
                        <i class="fas fa-credit-card mr-2"></i>Métodos de Pago
                    </button>
                    <button id="tab-temporal" class="tab-button py-4 px-6 text-center border-b-2 font-medium text-sm">
                        <i class="fas fa-calendar-alt mr-2"></i>Evolución Temporal
                    </button>
                </nav>
            </div>

            <!-- Contenido de pestañas -->
            <div class="p-6">
                <!-- Resumen -->
                <div id="content-resumen" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="card bg-white rounded-lg shadow p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                                    <i class="fas fa-exchange-alt text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Transacciones totales</p>
                                    <h3 id="total-transactions" class="text-2xl font-bold">--</h3>
                                </div>
                            </div>
                        </div>
                        <div class="card bg-white rounded-lg shadow p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                                    <i class="fas fa-dollar-sign text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Monto total</p>
                                    <h3 id="total-amount" class="text-2xl font-bold">--</h3>
                                </div>
                            </div>
                        </div>
                        <div class="card bg-white rounded-lg shadow p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-4">
                                    <i class="fas fa-percentage text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Tasa de completados</p>
                                    <h3 id="completion-rate" class="text-2xl font-bold">--</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Transacciones por Estado</h3>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                        <div class="card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Monto por Estado</h3>
                            <div class="chart-container">
                                <canvas id="amountStatusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Por Cursos -->
                <div id="content-cursos" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Transacciones por Curso</h3>
                            <div class="chart-container">
                                <canvas id="courseChart"></canvas>
                            </div>
                        </div>
                        <div class="card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Monto Recaudado por Curso</h3>
                            <div class="chart-container">
                                <canvas id="amountCourseChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Por Métodos de Pago -->
                <div id="content-metodos" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Transacciones por Método</h3>
                            <div class="chart-container">
                                <canvas id="paymentMethodChart"></canvas>
                            </div>
                        </div>
                        <div class="card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Monto por Método</h3>
                            <div class="chart-container">
                                <canvas id="amountPaymentMethodChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Evolución Temporal -->
                <div id="content-temporal" class="tab-content hidden">
                    <div class="grid grid-cols-1 gap-6">
                        <div class="card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Transacciones Diarias</h3>
                            <div class="chart-container">
                                <canvas id="dailyTransactionsChart"></canvas>
                            </div>
                        </div>
                        <div class="card bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Monto Diario</h3>
                            <div class="chart-container">
                                <canvas id="dailyAmountChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer class="bg-gray-800 text-white text-center py-4 mt-auto">
        <p>&copy; 2025 Dcm Development. Todos los derechos reservados.</p>
    </footer>

    <div id="logoutModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center z-50">
        <div class="relative p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Confirmar cierre de sesión</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">¿Estás seguro de que quieres cerrar tu sesión?</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmLogout" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 sm:ml-3 sm:w-auto sm:text-sm">
                        Sí, cerrar sesión
                    </button>
                    <button id="cancelLogout" class="mt-3 px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-75 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configuración inicial
            const loader = document.getElementById('loader');
            const loaderMessage = document.getElementById('loaderMessage');
            
            // Elementos de filtro
            const filtroFechaInicio = document.getElementById('filtro-fecha-inicio');
            const filtroFechaFin = document.getElementById('filtro-fecha-fin');
            const btnGenerarReporte = document.getElementById('btnGenerarReporte');
            const btnExportar = document.getElementById('btnExportar');
            
            // Pestañas
            const tabs = {
                'tab-resumen': 'content-resumen',
                'tab-cursos': 'content-cursos',
                'tab-metodos': 'content-metodos',
                'tab-temporal': 'content-temporal'
            };
            
            // Inicializar pestañas
            Object.keys(tabs).forEach(tabId => {
                document.getElementById(tabId).addEventListener('click', function() {
                    // Actualizar botones de pestaña
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Mostrar contenido correspondiente
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(tabs[tabId]).classList.remove('hidden');
                });
            });
            
            // Variables para almacenar datos y gráficos
            let chartInstances = {};
            let currentData = null;
            
            // Funciones auxiliares
            function formatMoney(amount) {
                return new Intl.NumberFormat('es-ES', {
                    style: 'currency',
                    currency: 'USD'
                }).format(amount);
            }
            
            function formatNumber(num) {
                return new Intl.NumberFormat('es-ES').format(num);
            }
            
            function showLoader(message) {
                loaderMessage.textContent = message;
                loader.classList.remove('hidden');
            }
            
            function hideLoader() {
                loader.classList.add('hidden');
            }
            
            function destroyCharts() {
                Object.values(chartInstances).forEach(chart => {
                    if (chart) chart.destroy();
                });
                chartInstances = {};
            }
            
            // Función para obtener datos
            async function fetchData(filters = {}) {
                showLoader('Cargando datos de transacciones...');
                
                try {
                    const apiUrlBase = '../../php/get_payment_stats.php';
                    
                    const formattedFilters = {};
                    if (filters.fecha_inicio) {
                        formattedFilters.fecha_inicio = new Date(filters.fecha_inicio).toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                    }
                    if (filters.fecha_fin) {
                        formattedFilters.fecha_fin = new Date(filters.fecha_fin).toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                    }
                    
                    const queryParams = new URLSearchParams(formattedFilters).toString();
                    const apiUrl = `${apiUrlBase}?${queryParams}`;
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Error HTTP ${response.status}: ${await response.text()}`);
                    }
                    
                    const data = await response.json();
                    currentData = data;
                    
                    updateSummary(data);
                    renderCharts(data);
                    
                } catch (error) {
                    console.error('Error al obtener datos:', error);
                    alert('Error al cargar los datos. Por favor intente nuevamente.');
                } finally {
                    hideLoader();
                }
            }
            
            // Actualizar resumen
            function updateSummary(data) {
                const basic = data.basic_stats;
                const amount = data.amount_stats;
                
                // Actualizar tarjetas de resumen
                document.getElementById('total-transactions').textContent = formatNumber(basic.total_transactions);
                document.getElementById('total-amount').textContent = formatMoney(basic.total_amount);
                
                const completionRate = (basic.status_counts.completed / basic.total_transactions * 100).toFixed(1);
                document.getElementById('completion-rate').textContent = `${completionRate}%`;
            }
            
            // Renderizar gráficos
            function renderCharts(data) {
                destroyCharts();
                
                const basic = data.basic_stats;
                const amount = data.amount_stats;
                const time = data.time_stats;
                
                // Gráficos de estado
                renderStatusChart(basic.status_counts, amount.by_status);
                
                // Gráficos por curso
                renderCourseCharts(basic.course_counts, amount.by_course);
                
                // Gráficos por método de pago
                renderPaymentMethodCharts(basic.payment_method_counts, amount.by_payment_method);
                
                // Gráficos temporales
                renderTimeCharts(time.daily);
            }
            
            // Gráficos de estado
            function renderStatusChart(statusCounts, amountByStatus) {
                const statusLabels = {
                    'completed': 'Completado',
                    'ready_to_be_checked': 'Pendiente',
                    'rejected': 'Rechazado'
                };
                
                // Gráfico de conteo por estado
                const statusLabelsArr = Object.keys(statusCounts).map(key => statusLabels[key] || key);
                const statusData = Object.values(statusCounts);
                
                chartInstances.statusChart = new Chart(
                    document.getElementById('statusChart'),
                    getChartConfig(
                        'doughnut',
                        statusLabelsArr,
                        statusData,
                        'Transacciones por Estado',
                        true
                    )
                );
                
                // Gráfico de monto por estado
                const amountLabelsArr = Object.keys(amountByStatus).map(key => statusLabels[key] || key);
                const amountData = Object.values(amountByStatus);
                
                chartInstances.amountStatusChart = new Chart(
                    document.getElementById('amountStatusChart'),
                    getChartConfig(
                        'bar',
                        amountLabelsArr,
                        amountData,
                        'Monto por Estado (USD)',
                        false,
                        true
                    )
                );
            }
            
            // Gráficos por curso
            function renderCourseCharts(courseCounts, amountByCourse) {
                // Limitar a los 10 principales cursos para mejor visualización
                const topCourses = Object.entries(courseCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                const courseLabels = topCourses.map(item => item[0]);
                const courseData = topCourses.map(item => item[1]);
                
                chartInstances.courseChart = new Chart(
                    document.getElementById('courseChart'),
                    getChartConfig(
                        'bar',
                        courseLabels,
                        courseData,
                        'Top 10 Cursos por Transacciones',
                        false
                    )
                );
                
                // Gráfico de monto por curso
                const topAmountCourses = Object.entries(amountByCourse)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                const amountCourseLabels = topAmountCourses.map(item => item[0]);
                const amountCourseData = topAmountCourses.map(item => item[1]);
                
                chartInstances.amountCourseChart = new Chart(
                    document.getElementById('amountCourseChart'),
                    getChartConfig(
                        'bar',
                        amountCourseLabels,
                        amountCourseData,
                        'Top 10 Cursos por Monto (USD)',
                        false,
                        true
                    )
                );
            }
            
            // Gráficos por método de pago
            function renderPaymentMethodCharts(methodCounts, amountByMethod) {
                const methodLabels = {
                    'paypal': 'PayPal',
                    'credit_card': 'Tarjeta de Crédito',
                    'bank_transfer': 'Transferencia Bancaria'
                    // Agregar más mapeos según sea necesario
                };
                
                const methodLabelsArr = Object.keys(methodCounts).map(key => methodLabels[key] || key);
                const methodData = Object.values(methodCounts);
                
                chartInstances.paymentMethodChart = new Chart(
                    document.getElementById('paymentMethodChart'),
                    getChartConfig(
                        'pie',
                        methodLabelsArr,
                        methodData,
                        'Transacciones por Método',
                        true
                    )
                );
                
                // Gráfico de monto por método
                const amountMethodLabelsArr = Object.keys(amountByMethod).map(key => methodLabels[key] || key);
                const amountMethodData = Object.values(amountByMethod);
                
                chartInstances.amountPaymentMethodChart = new Chart(
                    document.getElementById('amountPaymentMethodChart'),
                    getChartConfig(
                        'bar',
                        amountMethodLabelsArr,
                        amountMethodData,
                        'Monto por Método (USD)',
                        false,
                        true
                    )
                );
            }
            
            // Gráficos temporales
            function renderTimeCharts(dailyData) {
                const dates = Object.keys(dailyData).sort();
                const dailyCounts = dates.map(date => dailyData[date].count);
                const dailyAmounts = dates.map(date => dailyData[date].amount);
                
                // Configuración común para gráficos temporales
                const timeOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'dd MMM yyyy',
                                displayFormats: {
                                    day: 'dd MMM'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Fecha'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toLocaleString()}`;
                                }
                            }
                        }
                    }
                };
                
                // Gráfico de conteo diario
                chartInstances.dailyTransactionsChart = new Chart(
                    document.getElementById('dailyTransactionsChart'),
                    {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: 'Transacciones',
                                data: dailyCounts,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderWidth: 2,
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: timeOptions
                    }
                );
                
                // Gráfico de monto diario
                timeOptions.scales.y.title.text = 'Monto (USD)';
                
                chartInstances.dailyAmountChart = new Chart(
                    document.getElementById('dailyAmountChart'),
                    {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: 'Monto',
                                data: dailyAmounts,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderWidth: 2,
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: timeOptions
                    }
                );
            }
            
            // Función auxiliar para configurar gráficos comunes
            function getChartConfig(type, labels, data, title, showPercent = false, isMoney = false) {
                const backgroundColors = labels.map((_, i) => {
                    const hue = (i * 360 / labels.length) % 360;
                    return `hsla(${hue}, 70%, 60%, 0.7)`;
                });
                
                const borderColors = labels.map((_, i) => {
                    const hue = (i * 360 / labels.length) % 360;
                    return `hsl(${hue}, 70%, 60%)`;
                });
                
                const config = {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: title,
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: title,
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                position: type === 'pie' || type === 'doughnut' ? 'right' : 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        
                                        if (showPercent) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = Math.round((value / total) * 100);
                                            return `${label}: ${value} (${percentage}%)`;
                                        }
                                        
                                        if (isMoney) {
                                            return `${label}: ${formatMoney(value)}`;
                                        }
                                        
                                        return `${label}: ${value.toLocaleString()}`;
                                    }
                                }
                            }
                        }
                    }
                };
                
                if (type === 'bar') {
                    config.options.scales = {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (isMoney) {
                                        return formatMoney(value);
                                    }
                                    return value.toLocaleString();
                                }
                            }
                        }
                    };
                }
                
                return config;
            }
            
            // Exportar datos
            btnExportar.addEventListener('click', function() {
                if (!currentData) {
                    alert('No hay datos para exportar. Genere un reporte primero.');
                    return;
                }
                
                // Crear un blob con los datos en formato JSON
                const blob = new Blob([JSON.stringify(currentData, null, 2)], {
                    type: 'application/json'
                });
                
                // Crear un enlace de descarga
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reporte-transacciones-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            // Evento para generar reporte
            btnGenerarReporte.addEventListener('click', function() {
                const filters = {
                    fecha_inicio: filtroFechaInicio.value,
                    fecha_fin: filtroFechaFin.value
                };
                
                // Validación de fechas
                if (filters.fecha_inicio && filters.fecha_fin && filters.fecha_inicio > filters.fecha_fin) {
                    alert('La fecha de inicio no puede ser mayor que la fecha fin.');
                    return;
                }
                
                fetchData(filters);
            });
            
            // Inicializar con datos del mes actual
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            filtroFechaInicio.valueAsDate = firstDayOfMonth;
            filtroFechaFin.valueAsDate = today;
            
            fetchData({
                fecha_inicio: filtroFechaInicio.value,
                fecha_fin: filtroFechaFin.value
            });
        });
        // Lógica para el modal de cerrar sesión
        const logoutButton = document.getElementById('logout-button');
        const logoutModal = document.getElementById('logoutModal');
        const confirmLogoutButton = document.getElementById('confirmLogout');
        const cancelLogoutButton = document.getElementById('cancelLogout');

        // Mostrar el modal cuando se hace clic en "Cerrar sesión"
        logoutButton.addEventListener('click', function(event) {
            event.preventDefault(); // Prevenir el comportamiento por defecto del enlace
            logoutModal.classList.remove('hidden');
        });

        // Ocultar el modal cuando se hace clic en "Cancelar"
        cancelLogoutButton.addEventListener('click', function() {
            logoutModal.classList.add('hidden');
        });

        // Ocultar el modal si se hace clic fuera de él (opcional, pero buena UX)
        logoutModal.addEventListener('click', function(event) {
            if (event.target === logoutModal) {
                logoutModal.classList.add('hidden');
            }
        });

        // Lógica cuando se confirma el cierre de sesión
        confirmLogoutButton.addEventListener('click', function() {
            // Aquí iría la lógica real para cerrar la sesión:
            // - Limpiar cookies/localStorage (ej. tokens de autenticación)
            // - Redirigir a la página de inicio de sesión o a la página principal.

            // Por ahora, solo simularemos la redirección
            console.log("Cerrando sesión...");
            
            // Redirige a index.php
            window.location.href = '../index.php'; // Usa './index.php' si está en la misma carpeta raíz o similar

            // Si necesitas limpiar alguna data antes de la redirección, hazlo aquí.
            // Por ejemplo, para limpiar un token de autenticación en localStorage:
            // localStorage.removeItem('authToken'); 
            
            // El modal se ocultará automáticamente con la redirección,
            // pero puedes mantener la línea si lo deseas para casos de prueba o si la redirección no ocurre inmediatamente.
            logoutModal.classList.add('hidden'); 
        });
    </script>
</body>
</html>